<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:PocketMechanic.ViewModels"
             xmlns:models="clr-namespace:PocketMechanic.Models"
             x:Class="PocketMechanic.Views.VehicleDetailPage"
             x:DataType="viewmodels:VehicleDetailViewModel"
             Title="Vehicle Details">

    <RefreshView Command="{Binding RefreshCommand}">
        <ScrollView>
            <StackLayout Padding="20" Spacing="20">
                <!-- Vehicle Info Card -->
                <Border StrokeThickness="0" Padding="15" StrokeShape="RoundRectangle 10">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.3" Radius="10" Offset="0,2" />
                    </Border.Shadow>
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="10">
                        <Label Grid.Row="0" 
                               Text="{Binding Vehicle.DisplayName}"
                               FontSize="24"
                               FontAttributes="Bold"/>
                        
                        <Label Grid.Row="1">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding Vehicle.Year}"/>
                                    <Span Text=" "/>
                                    <Span Text="{Binding Vehicle.Make}"/>
                                    <Span Text=" "/>
                                    <Span Text="{Binding Vehicle.Model}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>

                        <Label Grid.Row="2" 
                               Text="{Binding Vehicle.CurrentMileage, StringFormat='Current Mileage: {0:N0} miles'}"
                               FontSize="16"/>

                        <Label Grid.Row="3" 
                               Text="{Binding Vehicle.VIN, StringFormat='VIN: {0}'}"
                               FontSize="14"
                               TextColor="Gray"
                               IsVisible="{Binding Vehicle.VIN, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>

                        <!-- Action Buttons -->
                        <Grid Grid.Row="4" ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10,0,0">
                            <Button Grid.Column="0" 
                                    Text="Edit" 
                                    Command="{Binding EditVehicleCommand}"
                                    FontSize="12"
                                    Padding="5"/>
                            <Button Grid.Column="1" 
                                    Text="Update Mileage" 
                                    Command="{Binding UpdateMileageCommand}"
                                    FontSize="12"
                                    Padding="5"/>
                            <Button Grid.Column="2" 
                                    Text="Delete" 
                                    Command="{Binding DeleteVehicleCommand}"
                                    BackgroundColor="Red"
                                    FontSize="12"
                                    Padding="5"/>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Overdue Items -->
                <StackLayout IsVisible="{Binding HasOverdueItems}">
                    <Label Text="Overdue Maintenance" 
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="Red"/>
                    <CollectionView ItemsSource="{Binding OverdueItems}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:MaintenanceRecord">
                                <Border Margin="0,5" Padding="10" BackgroundColor="#FFEBEE" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:VehicleDetailViewModel}}, Path=SelectMaintenanceCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackLayout Grid.Column="0">
                                            <Label Text="{Binding MaintenanceType}" FontAttributes="Bold"/>
                                            <Label Text="{Binding NextDueDate, StringFormat='Due: {0:MM/dd/yyyy}'}" 
                                                   FontSize="12"/>
                                        </StackLayout>
                                        <Label Grid.Column="1" Text="›" FontSize="24" TextColor="Gray" VerticalOptions="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>

                <!-- Due Soon Items -->
                <StackLayout IsVisible="{Binding HasDueSoonItems}">
                    <Label Text="Due Soon" 
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="Orange"/>
                    <CollectionView ItemsSource="{Binding DueSoonItems}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:MaintenanceRecord">
                                <Border Margin="0,5" Padding="10" BackgroundColor="#FFF3E0" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:VehicleDetailViewModel}}, Path=SelectMaintenanceCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackLayout Grid.Column="0">
                                            <Label Text="{Binding MaintenanceType}" FontAttributes="Bold"/>
                                            <Label Text="{Binding NextDueDate, StringFormat='Due: {0:MM/dd/yyyy}'}" 
                                                   FontSize="12"/>
                                        </StackLayout>
                                        <Label Grid.Column="1" Text="›" FontSize="24" TextColor="Gray" VerticalOptions="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>

                <!-- Add Maintenance Button -->
                <Button Text="+ Add Maintenance" 
                        Command="{Binding AddMaintenanceCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold"
                        HeightRequest="50"
                        CornerRadius="10"/>

                <!-- Maintenance History -->
                <StackLayout>
                    <Label Text="Maintenance History" 
                           FontSize="20"
                           FontAttributes="Bold"/>
                    
                    <Label Text="No maintenance records yet" 
                           TextColor="Gray"
                           IsVisible="{Binding HasMaintenanceHistory, Converter={StaticResource InvertedBoolConverter}}"
                           Margin="0,10,0,0"/>

                    <CollectionView ItemsSource="{Binding MaintenanceRecords}"
                                    IsVisible="{Binding HasMaintenanceHistory}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:MaintenanceRecord">
                                <SwipeView>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Delete"
                                                       BackgroundColor="Red"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:VehicleDetailViewModel}}, Path=DeleteMaintenanceCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>
                                    <Border Margin="0,5" Padding="10" Stroke="LightGray" StrokeThickness="1">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:VehicleDetailViewModel}}, Path=SelectMaintenanceCommand}"
                                                                  CommandParameter="{Binding .}"/>
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackLayout Grid.Column="0">
                                                <Label Text="{Binding MaintenanceType}" FontAttributes="Bold"/>
                                                <Label Text="{Binding DatePerformed, StringFormat='Performed: {0:MM/dd/yyyy}'}" 
                                                       FontSize="12"/>
                                                <Label Text="{Binding MileageAtService, StringFormat='At {0:N0} miles'}" 
                                                       FontSize="12"
                                                       TextColor="Gray"/>
                                            </StackLayout>
                                            <Label Grid.Column="1" Text="›" FontSize="24" TextColor="Gray" VerticalOptions="Center"/>
                                        </Grid>
                                    </Border>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </StackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
